<!--
SPDX-License-Identifier: LGPL-2.1-or-later
Copyright (C) 2026 Alexandre Licinio
-->
<%!
    import os, time
    from datetime import datetime
    
    def _parse_expire_date(value):
        s = (value or '').strip()
        if not s:
            return None
        try:
            e = float(s)
            if e > 1e12:
                e = e / 1000.0
            return e
        except Exception:
            pass
        
        # Try ISO-8601
        try:
            import re as _re
            s2 = s.replace('z', 'Z')
            if s2.endswith('Z'):
                s2 = s2[:-1] + '+00:00'
            # Fix timezone like +HHMM / -HHMM -> +HH:MM / -HH:MM
            s2 = _re.sub(r'([+-]\d{2})(\d{2})$', r'\1:\2', s2)
        except Exception:
            s2 = s

        # ISO 8601 (with or without time)
        try:
            from datetime import timezone as _tz
            dt = datetime.fromisoformat(s2)
            if dt.tzinfo is None:
                # Rule: naïve datetime interpreted as UTC
                dt = dt.replace(tzinfo=_tz.utc)
            return dt.timestamp()
        except Exception:
            pass

        # Date-only fallbacks
        for fmt in ("%Y-%m-%d", "%Y/%m/%d", "%d/%m/%Y"):
            try:
                from datetime import timezone as _tz
                dt = datetime.strptime(s, fmt).replace(tzinfo=_tz.utc)
                return dt.timestamp()
            except Exception:
                continue

        return None
%>
<!doctype html>
<html lang="en" data-bs-theme="light">
        <head>
        <meta charset="utf-8">
            <title>${page_title or 'StreamPilot'}</title>
            <meta name="viewport" content="width=device-width, initial-scale=1">
                <!-- Bootstrap 5 via CDN -->
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding-top: 1rem; }
                        .card-status { min-height: 160px; }
                        pre { white-space: pre-wrap; }
                    </style>
                    <style>
                        /* Dark theme overrides for full background and cards */
                        html[data-bs-theme='dark'] body { background-color: #121212; }
                        html[data-bs-theme='dark'] .navbar { background-color: #1b1b1b !important; }
                        html[data-bs-theme='dark'] .card { background-color: #1e1e1e; color: #eaeaea; border-color: #333; }
                        html[data-bs-theme='dark'] .card .card-header { background-color: #222; border-bottom-color: #333; color: #eaeaea; }
                        html[data-bs-theme='dark'] .badge.text-bg-secondary { color: #fff !important; background-color: #6c757d !important; }
                        html[data-bs-theme='dark'] pre { background-color: #0f0f0f; color: #d0d0d0; }
                    </style>
                </head>
        <body>
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">StreamPilot</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div id="mainNav" class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="/devices">Devices</a></li>
                        <li class="nav-item"><a class="nav-link" href="/health">Health</a></li>
                    </ul>
                    <div class="ms-auto d-flex align-items-center">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch">
                                <label class="form-check-label" for="themeSwitch">Dark mode</label>
                            </div>
                            % if client:
                            <span class="badge text-bg-secondary ms-3">${client}</span>
                                % endif
                                % if status:
                                % if status.lower() == 'demo':
                                <span class="badge text-bg-info ms-2">${status}</span>
                                % else:
                                <span class="badge text-bg-success ms-2">${status}</span>
                            % endif
                            <span class="ms-2">${_license_badge_html() | n}</span>
                        % endif
                    </div>
                </div>
            </div>
        </nav>
        
        <div class="container my-3">
            ${self.body()}
        </div>
        
        <script>
            (function(){
                const root = document.documentElement; // <html>
                const sw = document.getElementById('themeSwitch');
                // apply stored theme at startup
                const saved = localStorage.getItem('StreamPilotTheme');
                if (saved === 'dark' || saved === 'light') {
                    root.setAttribute('data-bs-theme', saved);
                }
                // reflect current theme on the switch
                const current = root.getAttribute('data-bs-theme') || 'light';
                if (sw) sw.checked = (current === 'dark');
                // toggle on change
                if (sw) {
                    sw.addEventListener('change', function(){
                        const next = sw.checked ? 'dark' : 'light';
                        root.setAttribute('data-bs-theme', next);
                        localStorage.setItem('StreamPilotTheme', next);
                    });
                }
            })();
        </script>
        <footer class="text-center text-muted mt-5 mb-3 small">
            Alexandre Licinio © 2026 — StreamPilot — Stream smarter. Pilot with precision. Broadcast better.
        </footer>
    </body>
</html>
